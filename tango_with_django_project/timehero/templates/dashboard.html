{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TimeHero</title>
    <link rel="stylesheet" href="{% static 'css/pixel.css' %}">
</head>
<body>

<!-- çŠ¶æ€æ  -->
<div class="status-bar">
    <div class="status-item">
        <img src="{% static 'sprites/hero.png' %}" class="pixel-icon">
        <span>Lv.{{ user.level }}</span> | <span>{{ user.username }}</span>
    </div>
    <div class="status-item">
        â¤ï¸ <span id="hp">{{ user.hp }}</span>/5
    </div>
    <div class="status-item">
        <img src="{% static 'sprites/coins.png' %}" class="pixel-icon">
        <span id="exp">{{ user.exp }}</span> EXP
    </div>
    <!-- ğŸš€ Logout æŒ‰é’® -->
    <div class="status-item logout">
        <form action="{% url 'logout' %}?next={% url 'index' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="pixel-btn logout-btn">ğŸšª Logout</button>
        </form>
    </div>
</div>

<!-- ä»»åŠ¡åœ°å›¾ -->
<div class="pixel-map">
    {% for task in tasks %}
        <div class="map-tile {% if task.is_completed %}completed{% endif %}" 
             data-task-id="{{ task.id }}"
             data-position-x="{{ task.position_x }}"
             data-position-y="{{ task.position_y }}">
            {% if task.difficulty == 3 %}ğŸ”¥{% else %}ğŸ“œ{% endif %}
        </div>
    {% endfor %}
</div>

<!-- ä»»åŠ¡é¢æ¿ -->
<div class="task-board">
    <h2 class="pixel-title">ğŸ“‹ Task Board</h2>
    <button class="pixel-btn" onclick="toggleTaskModal()">â• New Task</button>
    <div class="task-list">
        {% for task in tasks %}
        {% if task.user == request.user%}
        <div class="task-card {% if task.is_completed %}completed{% endif %}" id="task-{{ task.id }}">
            <div class="task-header">
                <span class="difficulty-{{ task.difficulty }}">
                    {{ task.get_difficulty_display }}
                </span>
                {% if not task.is_completed %}
                <button class="pixel-btn complete-task-btn" data-task-id="{{ task.id }}">
                    âœ… Complete
                </button>
                {% else %}
                <span class="completed-text">âœ”ï¸ Done</span>
                {% endif %}
            </div>
            <p class="task-title">{{ task.title }}</p>

            <!-- ä»»åŠ¡è¯¦æƒ…éƒ¨åˆ†ï¼Œåªæœ‰æœªå®Œæˆçš„ä»»åŠ¡æ‰æ˜¾ç¤º -->
            <div class="task-details" {% if task.is_completed %}style="display: none;"{% endif %}>
                {% if task.start_date %}
                <p class="task-time">ğŸ•’ Start: {{ task.start_date|date:"Y/m/d H:i" }}</p>
                {% endif %}
                {% if task.due_date %}
                <p class="task-due">â³ Due: {{ task.due_date|date:"Y/m/d H:i" }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>

<!-- ä»»åŠ¡åˆ›å»º/ç¼–è¾‘æ¨¡æ€æ¡† -->
<div id="taskModal" class="modal" style="display: none;">
    <div class="modal-content">
        <!-- å…³é—­æŒ‰é’® -->
        <span class="close" onclick="toggleTaskModal()">&times;</span>

        <!-- æ¨¡æ€æ¡†æ ‡é¢˜ï¼Œå¯æ ¹æ®éœ€è¦æ”¹ä¸ºâ€œCreate New Taskâ€æˆ–â€œEdit To Doâ€ -->
        <h2>Edit To Do</h2>

        <!-- ç¤ºä¾‹ï¼šåœ¨è¿™é‡ŒåŠ ä¸€å¥æç¤ºï¼ˆtodo: å®Œå–„é€»è¾‘ï¼‰ -->
        <p class="modal-instruction">
            You can either complete this To-Do, edit it, or remove it. <strong>[todo: å…·ä½“åŠŸèƒ½å¾…å®ç°]</strong>
        </p>

        <!-- è¡¨å•å¼€å§‹ -->
        <form id="taskForm" method="POST" action="{% url 'task-list' %}">
            {% csrf_token %}
            <!-- Hidden taskId input field -->
        <input type="hidden" id="taskId" name="taskId" value="">

            <!-- æ ‡é¢˜ -->
            <label for="taskTitle">Title:</label>
            <input type="text" id="taskTitle" name="title" required oninput="predictDifficulty()">

            <!-- å¤‡æ³¨ï¼ˆNotesï¼‰: todo: Markdown æ”¯æŒå¯åç»­å®ç° -->
            <label for="taskNotes">Notes: <em>[todo: Markdown formatting help]</em></label>
            <textarea id="taskNotes" name="notes" placeholder="Add any notes here..."></textarea>

            <!-- Checklist: todo: è¿™é‡Œå¯ä»¥ä½¿ç”¨JSåŠ¨æ€æ·»åŠ å­ä»»åŠ¡ -->
            <label for="taskChecklist">Checklist: <em>[todo]</em></label>
            <div id="taskChecklist">
                <!-- e.g. <input type="checkbox" name="subtask1" /> Subtask 1 -->
            </div>

            <!-- éš¾åº¦ï¼ˆDifficultyï¼‰: ä¿ç•™åŸæœ‰éš¾åº¦æ˜¾ç¤ºå’Œéšè—åŸŸï¼Œä»¥å…ç ´ååŸæœ‰åŠŸèƒ½ -->
            <label>Difficulty:</label>
            <span id="difficultyDisplay">Easy</span>
            <!-- éšè—åŸŸï¼Œå’ŒåŸæ¥çš„JSé€»è¾‘ä¿æŒä¸€è‡´ -->
            <input type="hidden" id="taskDifficulty" name="difficulty">

            <!-- åˆ°æœŸæ—¶é—´ -->
            <label for="taskDueDate">Due Date:</label>
            <input type="datetime-local" id="taskDueDate" name="due_date" onchange="calculateDuration()">

            <!-- Tags: todo -->
            <label for="taskTags">Tags: <em>[todo]</em></label>
            <input type="text" id="taskTags" name="tags" placeholder="e.g. Work, Personal">

            <!-- åŸæœ‰å­—æ®µï¼šå¼€å§‹æ—¶é—´ -->
            <label for="taskStartDate">Start Time:</label>
            <input type="datetime-local" id="taskStartDate" name="start_date">

            <!-- åŸæœ‰å­—æ®µï¼šä¼˜å…ˆçº§ -->
            <label for="taskPriority">High Priority:</label>
            <input type="checkbox" id="taskPriority" name="priority" value="true">

            <!-- ç¤ºä¾‹ï¼šåˆ é™¤æŒ‰é’®ï¼ˆtodo: å®ç°åˆ é™¤é€»è¾‘ï¼‰ -->
            <button type="button" class="pixel-btn" style="background-color: #ff4e4e;"
                    onclick="alert('todo: implement delete logic');">
                Delete this To-Do <em>[todo]</em>
            </button>

            <!-- æäº¤/ä¿å­˜æŒ‰é’® -->
            <button type="submit" class="pixel-btn">Save</button>

            <!-- å–æ¶ˆæŒ‰é’® -->
            <button type="button" class="pixel-btn" onclick="toggleTaskModal()">
                Cancel
            </button>
        </form>
    </div>
</div>

<!-- å»ºè®®åœ¨ <head> æˆ–å•ç‹¬çš„ CSS æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹æ ·å¼ -->
<style>
  /* ========== Modal æ ·å¼ ========== */
  .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
  }
  .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 400px;
      position: relative;
      border-radius: 5px;
  }
  .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
  }
  .close:hover,
  .close:focus {
      color: #000;
      text-decoration: none;
  }

  /* ========== Toast æ ·å¼ ========== */
  .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0.9;
      z-index: 10000;
      font-size: 14px;
  }

  /* ========== ç²’å­ç‰¹æ•ˆ ========== */
  .pixel-particle {
      position: absolute;
      width: 5px;
      height: 5px;
      background: gold;
      border-radius: 50%;
      animation: particle-fall 1s linear;
  }
  @keyframes particle-fall {
      0% {
          transform: translateY(0) scale(1);
          opacity: 1;
      }
      100% {
          transform: translateY(-100px) scale(0);
          opacity: 0;
      }
  }

  /* å…¶ä»–å¯æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰ï¼Œå¦‚ .pixel-btn, .task-card, .completed-text ç­‰ */
</style>

<script>
/* å½“é¡µé¢åŠ è½½å®Œæ¯•åæ‰§è¡Œ */
document.addEventListener("DOMContentLoaded", function () {
    // ç›‘å¬è¡¨å•ç›¸å…³äº‹ä»¶
    document.getElementById("taskTitle").addEventListener("input", predictDifficulty);
    document.getElementById("taskPriority").addEventListener("change", predictDifficulty);
    document.getElementById("taskDueDate").addEventListener("change", calculateDuration);
    document.getElementById("taskStartDate").addEventListener("change", calculateDuration);
    document.getElementById("taskForm").addEventListener("submit", submitTask);

    // åˆå§‹åŠ è½½ä»»åŠ¡
    fetchTasks();

    // ç›‘å¬ä»»åŠ¡åˆ—è¡¨ä¸­çš„æŒ‰é’®ç‚¹å‡»ï¼ˆå®Œæˆ / ç¼–è¾‘ / åˆ é™¤ç­‰ï¼‰
    document.querySelector(".task-list").addEventListener("click", function (event) {
        if (event.target.closest(".complete-task-btn")) {
            let taskId = event.target.closest(".complete-task-btn").dataset.taskId;
            completeTask(taskId, event);
        } else if (event.target.closest(".edit-task-btn")) {
            let taskId = event.target.closest(".edit-task-btn").dataset.taskId;
            editTask(taskId);
        } else if (event.target.closest(".delete-task-btn")) {
            let taskId = event.target.closest(".delete-task-btn").dataset.taskId;
            deleteTask(taskId);
        }
    });
});

/**
 * Toast æç¤º
 */
function showToast(message, duration = 3000) {
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), duration);
}

/**
 * æ˜¾ç¤º/éšè—ä»»åŠ¡åˆ›å»º/ç¼–è¾‘è¡¨å•çš„ Modal
 */
function toggleTaskModal(forceClose = false) {
    let modal = document.getElementById("taskModal");
    // è‹¥ forceClose ä¸º trueï¼Œåˆ™å¼ºåˆ¶éšè—
    if (forceClose) {
        modal.style.display = "none";
        return;
    }
    modal.style.display = (modal.style.display === "none" || modal.style.display === "") ? "block" : "none";
}

/**
 * æ¸…ç©ºå¹¶é‡ç½®è¡¨å•å†…å®¹
 */
function resetTaskForm() {
    document.getElementById("taskForm").reset();
    // é‡ç½®éšè—åŸŸ
    document.getElementById("taskId").value = "";
    // é‡ç½®éš¾åº¦æ˜¾ç¤º
    document.getElementById("difficultyDisplay").textContent = "Easy";
    document.getElementById("taskDifficulty").value = 1;
}

/**
 * è®¡ç®—ä»»åŠ¡æ—¶é•¿ï¼ˆåŸºäº Start Time å’Œ Due Dateï¼‰ï¼Œå¹¶è°ƒç”¨ predictDifficulty
 */
function calculateDuration() {
    let startInput = document.getElementById("taskStartDate").value;
    let dueInput = document.getElementById("taskDueDate").value;

    if (!dueInput) return;  // ç¡®ä¿è‡³å°‘æœ‰ Due Date

    let startDate = startInput ? new Date(startInput) : new Date();
    let dueDate = new Date(dueInput);

    let durationMinutes = Math.round((dueDate - startDate) / 60000);

    predictDifficulty(durationMinutes);
    if (dueDate < startDate) {
        showToast("æˆªæ­¢æ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ");
        document.getElementById("taskDueDate").value = "";
        return;
    }
}

/**
 * æ ¹æ®ä»»åŠ¡æ ‡é¢˜ã€æ—¶é•¿å’Œä¼˜å…ˆçº§é¢„æµ‹ä»»åŠ¡éš¾åº¦
 * @param {number} duration - ä»»åŠ¡æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ï¼Œé»˜è®¤30
 */
function predictDifficulty(duration = 30) {
    let title = document.getElementById("taskTitle").value.toLowerCase();
    let isHighPriority = document.getElementById("taskPriority").checked;
    let difficulty = 1;

    const keywordsHard = ["report", "study", "presentation", "deadline", "research"];
    const keywordsMedium = ["exercise", "meeting", "cleaning", "shopping"];

    // å…³é”®è¯åˆ¤æ–­
    if (keywordsHard.some(word => title.includes(word))) {
        difficulty = 3;
    } else if (keywordsMedium.some(word => title.includes(word))) {
        difficulty = 2;
    }

    // æ—¶é•¿åˆ¤æ–­
    if (duration > 120) {
        difficulty = Math.max(difficulty, 3);
    } else if (duration > 60) {
        difficulty = Math.max(difficulty, 2);
    }

    // ä¼˜å…ˆçº§åˆ¤æ–­
    if (isHighPriority) {
        difficulty = Math.min(3, difficulty + 1);
    }

    let difficultyDisplay = ["Easy", "Medium", "Hard"];
    document.getElementById("difficultyDisplay").textContent = difficultyDisplay[difficulty - 1];
    document.getElementById("taskDifficulty").value = difficulty;
}

/**
 * è·å–å¹¶åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
 */
async function fetchTasks() {
    try {
        const response = await fetch("/api/tasks/", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("token")}`
            }
        });
        if (!response.ok) throw new Error("Failed to load tasks");
        const tasks = await response.json();
        updateTaskBoard(tasks);
        updateTaskMap(tasks);
    } catch (error) {
        console.error("ä»»åŠ¡åŠ è½½å¤±è´¥:", error);
    }
}

/**
 * æäº¤ä»»åŠ¡è¡¨å•ï¼ˆåŒºåˆ†æ–°å»ºæˆ–æ›´æ–°ï¼‰
 */
async function submitTask(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const taskId = document.getElementById("taskId").value.trim();

    // æ ¹æ®æ˜¯å¦æœ‰ taskId åˆ¤æ–­æ˜¯æ–°å»ºè¿˜æ˜¯æ›´æ–°
    let url = "/api/tasks/";
    let method = "POST";
    if (taskId) {
        url = `/api/tasks/${taskId}/`;
        method = "PUT";  // æ›´æ–°
    }

    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: formData
        });

        if (response.ok) {
            toggleTaskModal(true); // å…³é—­å¼¹çª—
            resetTaskForm();       // é‡ç½®è¡¨å•
            fetchTasks();          // é‡æ–°åŠ è½½ä»»åŠ¡
        } else {
            console.error("ä»»åŠ¡åˆ›å»º/æ›´æ–°å¤±è´¥");
        }
    } catch (error) {
        console.error("ä»»åŠ¡æäº¤å¤±è´¥:", error);
    }
}

/**
 * ç¼–è¾‘ä»»åŠ¡ï¼šè·å–ç°æœ‰ä»»åŠ¡æ•°æ®ï¼Œå¡«å……åˆ°è¡¨å•åæ‰“å¼€å¼¹çª—
 */
async function editTask(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}/`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("token")}`
            }
        });
        if (!response.ok) throw new Error("Failed to fetch task data");
        const task = await response.json();

        // å¡«å……è¡¨å•
        document.getElementById("taskId").value = task.id;
        document.getElementById("taskTitle").value = task.title || "";
        document.getElementById("taskNotes").value = task.notes || "";
        document.getElementById("taskDueDate").value = task.due_date
            ? new Date(task.due_date).toISOString().slice(0, 16)
            : "";
        document.getElementById("taskStartDate").value = task.start_date
            ? new Date(task.start_date).toISOString().slice(0, 16)
            : "";
        document.getElementById("taskPriority").checked = !!task.priority;
        document.getElementById("taskDifficulty").value = task.difficulty || 1;
        document.getElementById("difficultyDisplay").textContent = ["Easy","Medium","Hard"][ (task.difficulty || 1) - 1 ];

        // æ‰“å¼€å¼¹çª—
        toggleTaskModal();
    } catch (error) {
        console.error("ç¼–è¾‘ä»»åŠ¡æ—¶è·å–æ•°æ®å¤±è´¥:", error);
    }
}

/**
 * å®Œæˆä»»åŠ¡
 */
async function completeTask(taskId, event) {
    try {
        const response = await fetch(`/api/tasks/${taskId}/complete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            // å‰ç«¯ç›´æ¥æ›´æ–°UI
            let taskCard = document.getElementById(`task-${taskId}`);
            if (taskCard) {
                let details = taskCard.querySelector(".task-details");
                if (details) details.style.display = "none";

                let completeButton = taskCard.querySelector(".complete-task-btn");
                if (completeButton) completeButton.remove();

                let doneBadge = document.createElement("span");
                doneBadge.className = "completed-text";
                doneBadge.textContent = "âœ”ï¸ Done";
                taskCard.querySelector(".task-header").appendChild(doneBadge);
            }

            // ç²’å­ç‰¹æ•ˆ
            if (event) createParticles(event.clientX, event.clientY);

            // æ›´æ–°ç»éªŒå€¼
            if (data.exp !== undefined) {
                document.getElementById("exp").textContent = data.exp;
            }
        } else {
            console.error("Task completion failed");
        }
    } catch (error) {
        console.error("Task completion request error:", error);
    }
}

/**
 * åˆ é™¤ä»»åŠ¡ï¼ˆç¤ºä¾‹ï¼‰
 */
async function deleteTask(taskId) {
    if (!confirm("Are you sure to delete this task?")) return;
    try {
        const response = await fetch(`/api/tasks/${taskId}/`, {
            method: "DELETE",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "Authorization": `Bearer ${localStorage.getItem("token")}`
            }
        });
        if (response.ok) {
            showToast("Task deleted successfully");
            fetchTasks();
        } else {
            console.error("Task deletion failed");
        }
    } catch (error) {
        console.error("Delete request error:", error);
    }
}

/**
 * æ›´æ–°ä»»åŠ¡é¢æ¿
 */
function updateTaskBoard(tasks) {
    const taskList = document.querySelector(".task-list");
    taskList.innerHTML = "";

    tasks.forEach(task => {
        let taskElement = document.createElement("div");
        taskElement.className = `task-card ${task.is_completed ? "completed" : ""}`;
        taskElement.id = `task-${task.id}`;

        taskElement.innerHTML = `
            <div class="task-header">
                <span class="difficulty-${task.difficulty}">
                    ${["Easy", "Medium", "Hard"][task.difficulty - 1]}
                </span>
                ${task.is_completed ? `<span class="completed-text">âœ”ï¸ Done</span>` : ""}
                <p class="task-title">${task.title}</p>
            </div>
            <div class="task-details" style="display: ${task.is_completed ? 'none' : 'block'};">
                ${task.start_date ? `<p class="task-start">ğŸš€ Start: <span>${formatDate(task.start_date)}</span></p>` : ""}
                ${task.due_date ? `<p class="task-due">â³ Due: <span>${formatDate(task.due_date)}</span></p>` : ""}
            </div>
            ${
              !task.is_completed
              ? `<button class="pixel-btn complete-task-btn" data-task-id="${task.id}">âœ… Complete</button>
                 <button class="pixel-btn edit-task-btn" data-task-id="${task.id}">âœï¸ Edit</button>
                 <button class="pixel-btn delete-task-btn" data-task-id="${task.id}">âŒ Delete</button>`
              : ""
            }
        `;
        taskList.appendChild(taskElement);
    });
}

/**
 * æ›´æ–°ä»»åŠ¡åœ°å›¾
 */
function updateTaskMap(tasks) {
    const map = document.querySelector(".pixel-map");
    map.innerHTML = "";

    tasks.forEach(task => {
        let mapTile = document.createElement("div");
        mapTile.className = `map-tile ${task.is_completed ? "completed" : ""}`;
        mapTile.dataset.taskId = task.id;
        mapTile.dataset.positionX = task.position_x || 1;
        mapTile.dataset.positionY = task.position_y || 1;

        // å¦‚æœä½¿ç”¨ CSS Gridï¼Œéœ€è¦è®¾ç½® gridColumn / gridRow
        mapTile.style.gridColumn = task.position_x || 1;
        mapTile.style.gridRow = task.position_y || 1;

        mapTile.innerHTML = task.difficulty === 3 ? "ğŸ”¥" : "ğŸ“œ";
        map.appendChild(mapTile);
    });
}

/**
 * ç²’å­ç‰¹æ•ˆ
 */
function createParticles(x, y) {
    for (let i = 0; i < 20; i++) {
        const particle = document.createElement("div");
        particle.className = "pixel-particle";
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 1000);
    }
}

/**
 * è·å– CSRF ä»¤ç‰Œ
 */
function getCookie(name) {
    let cookieValue = null;
    document.cookie.split(";").forEach(cookie => {
        if (cookie.trim().startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.split("=")[1]);
        }
    });
    return cookieValue;
}

/**
 * æ ¼å¼åŒ–æ—¥æœŸ
 */
function formatDate(isoString) {
    let date = new Date(isoString);
    return date.toLocaleString();
}
</script>

</body>
</html>
